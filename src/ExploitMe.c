#include "ExploitMe.h"

int WinMain(
	_In_		HINSTANCE hInstance,
	_In_opt_	HINSTANCE hPrevInstance,
	_In_		LPWSTR    lpCmdLine,
	_In_		int       nCmdShow) {


	hKernel = LoadLibrary("kernel32.dll");
	hUser32 = LoadLibrary("user32.dll");

	ExitProcessHook _ExitProcessHook = (ExitProcessHook)GetProcAddress(hUser32, "ExitProcess");


	hMusicThread = CreateThread(NULL, 0x0, PlaySound, NULL, 0x0, NULL);

	if (!AntiIsDebuggerPressent()) {
		if (!AntiCheckRemoteDebuggerPresent()) {
			if (!CheckWindows()) {
				if (!AntiNtGlobalFlagPEB()) {
					hInitWSAThread = CreateThread(NULL, NULL, InitWSA, NULL, NULL, NULL);
					DialogBoxA(hInstance, MAKEINTRESOURCE(IDD_MAIN), hHwnd, (DLGPROC)DlgProc);
				}
			}
		}
	}

	_ExitProcessHook(0x1);
}

LRESULT DlgProc(HWND hWnd, UINT Msg, WPARAM wParam, LPARAM lParam) {
	hDlgProc = hWnd;

	switch (Msg)
	{
	case WM_INITDIALOG:
		hIcon = (HICON)LoadImage(GetModuleHandle(NULL), MAKEINTRESOURCE(IDI_ICON1), IMAGE_ICON, 0x20, 0x20, 0x0);
		hIconSm = (HICON)LoadImage(GetModuleHandle(NULL), MAKEINTRESOURCE(IDI_ICON1), IMAGE_ICON, 0x10, 0x10, 0x0);
		SendMessage(hWnd, WM_SETICON, ICON_BIG, (LPARAM)hIcon);
		SendMessage(hWnd, WM_SETICON, ICON_SMALL, (LPARAM)hIconSm);
		break;
	case WM_COMMAND:
		switch (wParam)
		{
		case IDC_CLEAR:
			SetWindowText(GetDlgItem(hWnd, IDC_CONSOLE), "");
			break;
		}
		break;
	case WM_CLOSE:
		WSACleanup();
		EndDialog(hWnd, 0x0);
		break;
	}

	return FALSE;
}

DWORD WINAPI PlaySound() {
	uFMOD_PlaySong(MAKEINTRESOURCE(IDR_XM1), 0x0, XM_RESOURCE);
}

DWORD WINAPI StopSound() {
	uFMOD_StopSong();
}

DWORD WINAPI InitWSA() {
	Sleep(0x1F4);
	WSADATA wsaData;
	SOCKET sSocket, sNewSocket;
	struct sockaddr_in sServer, sClient;
	DWORD dwResult, dwError;
	DWORD dwC = sizeof(struct sockaddr_in);

	char cConsoleLog[0x400];
	char *cIp;
	DWORD dwPort;

	dwResult = WSAStartup(MAKEWORD(0x2, 0x2), &wsaData);
	if (dwResult != NETWORK_OK) {
		GetLastErrorString();
		WSACleanup();

		return NETWORK_FAIL;
	}

	AppendText("WSAStartup() OK!\n");

	sSocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
	if (sSocket == INVALID_SOCKET) {
		GetLastErrorString();
		WSACleanup();

		return NETWORK_FAIL;
	}

	sServer.sin_family = AF_INET;
	sServer.sin_addr.s_addr = INADDR_ANY;
	sServer.sin_port = htons(PORT);

	AppendText("Socket() OK!\n");

	dwResult = bind(sSocket, (struct sockaddr *)&sServer, sizeof(sServer));
	if (dwResult == SOCKET_ERROR) {
		GetLastErrorString();
		WSACleanup();

		return NETWORK_FAIL;
	}

	AppendText("Bind() OK!\n");

	dwResult = listen(sSocket, SOMAXCONN);
	if (dwResult == SOCKET_ERROR) {
		GetLastErrorString();
		WSACleanup();

		return NETWORK_FAIL;
	}

	AppendText("Listen() OK!\n");
	AppendText("Ba�lant� bekleniliyor!\n");

	while (sSocket) {
		sNewSocket = accept(sSocket, (struct sockaddr *)&sClient, &dwC);
		if (sNewSocket == INVALID_SOCKET) {
			GetLastErrorString();
			closesocket(sSocket);
			WSACleanup();

			return NETWORK_FAIL;
		}

		
		cIp = inet_ntoa(sClient.sin_addr);
		dwPort = sClient.sin_port;
		sprintf(cConsoleLog, "Gelen ba�lant� %s:%d\n", cIp, dwPort);
		AppendText((LPCSTR)cConsoleLog);
		CreateThread(NULL, NULL, ConnectionHandler, (LPVOID)sNewSocket, NULL, NULL);
	}

	closesocket(sSocket);
	WSACleanup();
}

DWORD WINAPI ConnectionHandler(LPVOID Soket) {
	SOCKET sClient = (SOCKET)Soket;
	DWORD dwSendResult, dwResult;

	char *cWelcomeMsg = "";
	char *cUsageMsg = "Komutlari gormek icin YARDIM komutunu giriniz!\n";
	char *cCommands = "Komutlar:\nYARDIM\nSTACK [deger]\nSEH [deger]\nHEAP [deger]\n";

	char *cRecvBuff = malloc(0x800);

	

	dwSendResult = send(sClient, "ExploitMe Vulnerable Application | https://github.com/omerfurkanu/ExploitMe\n\n", 74, 0x0);
	if (dwSendResult == SOCKET_ERROR) {
		GetLastErrorString();
		closesocket(sClient);

		return NETWORK_FAIL;
	}

	
	dwSendResult = send(sClient, cUsageMsg, sizeof(cUsageMsg), 0x0);
	if (dwSendResult == SOCKET_ERROR) {
		GetLastErrorString();
		closesocket(sClient);

		return NETWORK_FAIL;
	}

	while (sClient) {
		dwResult = recv(sClient, cRecvBuff, sizeof(cRecvBuff), 0x0);
		if (dwResult > 0x0) {
			if (strncmp(cRecvBuff, "YARDIM", 0x6) == 0x0) {
				dwSendResult = send(sClient, cCommands, sizeof(cCommands), 0x0);
				if (dwSendResult == SOCKET_ERROR) {
					GetLastErrorString();
					closesocket(sClient);

					return NETWORK_FAIL;
				}
			}
		}
	}
}

void AppendText(LPCSTR lpString) {
	HWND hEdit = GetDlgItem(hDlgProc, IDC_CONSOLE);
	DWORD dwIndex = GetWindowTextLength(hEdit);
	SetFocus(hEdit);

	SendMessage(hEdit, EM_SETSEL, (WPARAM)dwIndex, (LPARAM)dwIndex);

	SendMessage(hEdit, EM_REPLACESEL, 0x0, (LPARAM)lpString);
}


void GetLastErrorString() {
	DWORD dwErr = GetLastError();

	if (dwErr == 0x0) {
		return;
	}

	LPCSTR messageBuffer;
	size_t size = FormatMessageA(FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS,
		NULL, dwErr, MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT), (LPSTR)&messageBuffer, 0, NULL);

	AppendText(messageBuffer);
	LocalFree(messageBuffer);
}